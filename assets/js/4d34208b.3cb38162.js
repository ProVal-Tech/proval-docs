"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[55690],{357171:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"cwa/scripts/458b387d-e369-4ea5-bbc6-608e4ea7f993","title":"Autofix - CWC RMM+ - Offline Agent Remediation","description":"This document describes a script that restarts agent services or reinstalls the agent if the services fail to restart. It outlines the dependencies, global parameters, process flow, and expected output, making it essential for managing agents in ConnectWise RMM.","source":"@site/docs/cwa/scripts/Autofix - CWC RMM+ - Offline Agent Remediation.md","sourceDirName":"cwa/scripts","slug":"/cwa/scripts/458b387d-e369-4ea5-bbc6-608e4ea7f993","permalink":"/docs/cwa/scripts/458b387d-e369-4ea5-bbc6-608e4ea7f993","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/scripts/Autofix - CWC RMM+ - Offline Agent Remediation.md","tags":[{"inline":false,"label":"Ticketing","permalink":"/docs/tags/ticketing","description":"Documents related to ticketing systems and IT support management"}],"version":"current","frontMatter":{"id":"458b387d-e369-4ea5-bbc6-608e4ea7f993","title":"Autofix - CWC RMM+ - Offline Agent Remediation","title_meta":"Autofix - CWC RMM+ - Offline Agent Remediation","keywords":["restart","agent","services","reinstall","monitor","ticketing","automation"],"description":"This document describes a script that restarts agent services or reinstalls the agent if the services fail to restart. It outlines the dependencies, global parameters, process flow, and expected output, making it essential for managing agents in ConnectWise RMM.","tags":["ticketing"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"Auto Close - Missing Patch Tickets Autofix","permalink":"/docs/cwa/scripts/e1b8cfd0-d42d-4056-ac55-82a30f5bdffd"},"next":{"title":"Autofix - Monitor AV Service Status","permalink":"/docs/cwa/scripts/1986c949-6d8f-40e6-b802-c32195c9a2d3"}}');var s=n(474848),l=n(28453);const r={id:"458b387d-e369-4ea5-bbc6-608e4ea7f993",title:"Autofix - CWC RMM+ - Offline Agent Remediation",title_meta:"Autofix - CWC RMM+ - Offline Agent Remediation",keywords:["restart","agent","services","reinstall","monitor","ticketing","automation"],description:"This document describes a script that restarts agent services or reinstalls the agent if the services fail to restart. It outlines the dependencies, global parameters, process flow, and expected output, making it essential for managing agents in ConnectWise RMM.",tags:["ticketing"],draft:!1,unlisted:!1},c=void 0,a={},o=[{value:"Summary",id:"summary",level:2},{value:"Sample Run",id:"sample-run",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Global Parameters",id:"global-parameters",level:4},{value:"Script States",id:"script-states",level:4},{value:"Process",id:"process",level:2},{value:"Output",id:"output",level:2},{value:"Change Log",id:"change-log",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",h4:"h4",li:"li",ol:"ol",p:"p",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(t.p,{children:"This script will restart agent services or attempt to reinstall the agent if restarting the services fails."}),"\n",(0,s.jsx)(t.p,{children:"Replaces:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"CW Control RMM+ API - Offline Agent Remediation (Agent Reinstall) [Autofix, Globals, Ticket]*"}),"\n",(0,s.jsx)(t.li,{children:"CW Control RMM+ API - Offline Agent Remediation (Agent Restart) [Autofix, Globals, Ticket] - V2"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"sample-run",children:"Sample Run"}),"\n",(0,s.jsx)(t.p,{children:"This script is an autofix to a monitor and should not be manually run."}),"\n",(0,s.jsx)(t.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Agent Install - Generate Location URL"}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/cwa/scripts/18562eaa-d162-4362-98d3-4bbaa2922458",children:"CWM - Control - Script - CW Control RMM+ API - Is Online [Properties]*"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/cwa/scripts/b713bbc8-a1d9-4e08-ac77-d02b634569f6",children:"CWM - Control - Script - CW Control RMM+ API - Execute Command*"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/cwa/scripts/567b8db7-a87a-45c1-a81a-b3178090fb52",children:"SWM - Software Install - Script - CW Control RMM+ API - LTPosh Redo-LTService*"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/cwa/monitors/4bc06cc4-3b78-452a-b602-063e57221234",children:"CWM - Automate - Monitor - No Checkin for More Than 30 Days*"})}),"\n",(0,s.jsxs)(t.li,{children:["LTPoSH Community Module (",(0,s.jsx)(t.a,{href:"https://bit.ly/LTPoSH",children:"https://bit.ly/LTPoSH"}),")"]}),"\n",(0,s.jsx)(t.li,{children:"RMM+ Plugin Configured in CW Control portal"}),"\n",(0,s.jsx)(t.li,{children:"System Properties (See below)"}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"global-parameters",children:"Global Parameters"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Name"}),(0,s.jsx)(t.th,{children:"Example"}),(0,s.jsx)(t.th,{children:"Required"}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"Re-Install"}),(0,s.jsx)(t.td,{children:"1 or anything else"}),(0,s.jsx)(t.td,{children:"Defaulted to 1"}),(0,s.jsx)(t.td,{children:"1 enables the reinstallation of the agent if restarting the services fails; 0 will not attempt a reinstall if restarting services fail."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"TicketingEnabled"}),(0,s.jsx)(t.td,{children:"1 or anything else"}),(0,s.jsx)(t.td,{children:"Defaults to 1"}),(0,s.jsx)(t.td,{children:"1 enables the creation of tickets; anything else disables it."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"TicketCreationCategory"}),(0,s.jsx)(t.td,{children:"0 or anything else"}),(0,s.jsx)(t.td,{children:"Defaults to 164"}),(0,s.jsx)(t.td,{children:"This is used in the event of a success status to determine if a finish ticket is appropriate; 0 indicates no ticket finishing is required."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"DuplicateCheck"}),(0,s.jsx)(t.td,{children:"0 or anything else"}),(0,s.jsx)(t.td,{children:"Defaults to 0"}),(0,s.jsx)(t.td,{children:"Anything but 0 enables a duplicate check; 0 will not check for duplicates."})]})]})]}),"\n",(0,s.jsx)(t.h4,{id:"script-states",children:"Script States"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Name"}),(0,s.jsx)(t.th,{children:"Example"}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"AgentStatus"}),(0,s.jsx)(t.td,{children:"Broken for computer 1234"}),(0,s.jsx)(t.td,{children:"Reflects an agent status (online, offline, broken)."})]})})]}),"\n",(0,s.jsx)(t.h2,{id:"process",children:"Process"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["If Status is False","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["If DuplicateCheck is anything but 0","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Get SerialNumber"}),"\n",(0,s.jsx)(t.li,{children:"Count the number of identical serial numbers in the database"}),"\n",(0,s.jsxs)(t.li,{children:["If Count does not equal 0","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Log message"}),"\n",(0,s.jsx)(t.li,{children:"Select the most recent Computer ID for this computer"}),"\n",(0,s.jsx)(t.li,{children:"Delete WHERE ComputerId is anything except the most recent Computer ID and BIOS version is the Serial Number and ClientId is the Client ID."}),"\n",(0,s.jsxs)(t.li,{children:["If the last contact of this machine is within the last 15 minutes","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Log that the computer is online"}),"\n",(0,s.jsx)(t.li,{children:"Exit the script"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Start initial check"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Start initial check"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["Initial check","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Run the API - is online script"}),"\n",(0,s.jsxs)(t.li,{children:["If the computer is not online","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Log agent offline"}),"\n",(0,s.jsx)(t.li,{children:"Set the script state to Offline for computer ###"}),"\n",(0,s.jsx)(t.li,{children:"Exit script"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Log agent is online"}),"\n",(0,s.jsxs)(t.li,{children:["Set the registry key ",(0,s.jsx)(t.code,{children:"DisableRootAutoUpdate"})," = 0 at the path ",(0,s.jsx)(t.code,{children:"HKLM://SOFTWARE//Policies//Microsoft//SystemCertificates//AuthRoot"}),"."]}),"\n",(0,s.jsx)(t.li,{children:"Push agent service restart command to ConnectWise control via RMM+"}),"\n",(0,s.jsxs)(t.li,{children:["While contact attempt is less than three","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Sleep 5 minutes"}),"\n",(0,s.jsx)(t.li,{children:"Add 1 to attempt"}),"\n",(0,s.jsx)(t.li,{children:"Check the connection state"}),"\n",(0,s.jsxs)(t.li,{children:["If the state of the agent is not online","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["If it's not the 3rd attempt","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Return to 5.1"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["If Re-Install agent is on","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Log state"}),"\n",(0,s.jsx)(t.li,{children:"Run LTPoSH redo LTService script"}),"\n",(0,s.jsxs)(t.li,{children:["While contact attempt is less than 3","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Sleep 5 minutes"}),"\n",(0,s.jsx)(t.li,{children:"Add 1 to attempt"}),"\n",(0,s.jsx)(t.li,{children:"Check the connection state"}),"\n",(0,s.jsxs)(t.li,{children:["If the agent is still offline","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["If it's not the 3rd attempt","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Return to 5.4.2.3"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Log that the agent is online"}),"\n",(0,s.jsx)(t.li,{children:"Clear the script state"}),"\n",(0,s.jsx)(t.li,{children:"Exit script"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Log broken agent"}),"\n",(0,s.jsx)(t.li,{children:"Set state to broken for Computer ###"}),"\n",(0,s.jsxs)(t.li,{children:["If ticketing is not enabled","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Exit with error"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Create ticket"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Log the situation"}),"\n",(0,s.jsx)(t.li,{children:"Set the state to Broken for Computer ###"}),"\n",(0,s.jsxs)(t.li,{children:["Reset the value of the registry key ",(0,s.jsx)(t.code,{children:"DisableRootAutoUpdate"}),", if it was 1 before restarting the agent."]}),"\n",(0,s.jsxs)(t.li,{children:["If ticketing is not enabled","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Exit with error"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Set the ticket subject, body, and ID"}),"\n",(0,s.jsxs)(t.li,{children:["If the ticket ID is anything but 0","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Comment ticket to admin"}),"\n",(0,s.jsx)(t.li,{children:"Exit script"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Create ticket"}),"\n",(0,s.jsx)(t.li,{children:"Exit"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["Reset the value of the registry key ",(0,s.jsx)(t.code,{children:"DisableRootAutoUpdate"}),", if it was 1 before restarting the agent."]}),"\n",(0,s.jsx)(t.li,{children:"Log that the Automate Agent is online"}),"\n",(0,s.jsx)(t.li,{children:"Clear the script state"}),"\n",(0,s.jsx)(t.li,{children:"Exit script"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"output",children:"Output"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Script log"}),"\n",(0,s.jsx)(t.li,{children:"Script state"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"change-log",children:"Change Log"}),"\n",(0,s.jsx)(t.p,{children:"01-2023: Added functionality to handle registry key entry preventing repair."})]})}function h(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>c});var i=n(296540);const s={},l=i.createContext(s);function r(e){const t=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(l.Provider,{value:t},e.children)}}}]);