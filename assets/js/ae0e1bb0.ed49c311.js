"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[58559],{234075:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"cwa/monitors/2549fcf6-30b5-497b-b44d-7329334bb32c","title":"AD Account LockOut Detection","description":"This document provides a step-by-step guide on how to set up a custom ticket creation process for computer failures in ConnectWise Automate. It includes instructions for importing alert templates, validating scripts, running SQL queries, and configuring monitors specifically for Domain Controllers.","source":"@site/docs/cwa/monitors/AD Account LockOut Detection.md","sourceDirName":"cwa/monitors","slug":"/cwa/monitors/2549fcf6-30b5-497b-b44d-7329334bb32c","permalink":"/docs/cwa/monitors/2549fcf6-30b5-497b-b44d-7329334bb32c","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/monitors/AD Account LockOut Detection.md","tags":[{"inline":false,"label":"Active Directory","permalink":"/docs/tags/active-directory","description":"Documents related to Active Directory services and management"},{"inline":false,"label":"SQL","permalink":"/docs/tags/sql","description":"Documents discussing Structured Query Language and database interactions"},{"inline":false,"label":"Windows","permalink":"/docs/tags/windows","description":"Documents related to Microsoft Windows operating system and its functionalities"}],"version":"current","frontMatter":{"id":"2549fcf6-30b5-497b-b44d-7329334bb32c","title":"AD Account LockOut Detection","title_meta":"AD Account LockOut Detection","keywords":["alert","template","monitor","sql","ticket","creation","failures","detection","domain","controllers"],"description":"This document provides a step-by-step guide on how to set up a custom ticket creation process for computer failures in ConnectWise Automate. It includes instructions for importing alert templates, validating scripts, running SQL queries, and configuring monitors specifically for Domain Controllers.","tags":["active-directory","sql","windows"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"AC Power Saving Option Detection","permalink":"/docs/cwa/monitors/54425c6a-e77c-4c65-ab46-810e6abbb71d"},"next":{"title":"AD Recycle Bin State Check","permalink":"/docs/cwa/monitors/5041d497-ae6c-4209-a338-60f1da396106"}}');var o=n(474848),s=n(28453);const a={id:"2549fcf6-30b5-497b-b44d-7329334bb32c",title:"AD Account LockOut Detection",title_meta:"AD Account LockOut Detection",keywords:["alert","template","monitor","sql","ticket","creation","failures","detection","domain","controllers"],description:"This document provides a step-by-step guide on how to set up a custom ticket creation process for computer failures in ConnectWise Automate. It includes instructions for importing alert templates, validating scripts, running SQL queries, and configuring monitors specifically for Domain Controllers.",tags:["active-directory","sql","windows"],draft:!1,unlisted:!1},i=void 0,c={},d=[{value:"Step 1",id:"step-1",level:3},{value:"Step 2",id:"step-2",level:3},{value:"Step 3",id:"step-3",level:3},{value:"Step 4",id:"step-4",level:3},{value:"Step 5",id:"step-5",level:3}];function l(e){const t={br:"br",code:"code",h3:"h3",hr:"hr",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h3,{id:"step-1",children:"Step 1"}),"\n",(0,o.jsxs)(t.p,{children:["Import the Alert Template ",(0,o.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"}),"."]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h3,{id:"step-2",children:"Step 2"}),"\n",(0,o.jsx)(t.p,{children:"Validate that the [CWM - Automate - Script - Ticket Creation - Computer [Failures Only]](../scripts/Ticket Creation - Computer Failures Only.md) script was imported as well and that the alert template is executing this script for failures only."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h3,{id:"step-3",children:"Step 3"}),"\n",(0,o.jsx)(t.p,{children:"Run this SQL query from a RAWSQL monitor set to create and set the remote monitor on the Domain Controllers group:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"SET @Groupid = (SELECT Groupid FROM mastergroups WHERE `GUID` = '3ac455da-f1fb-11e1-b4ec-1231391d2d19');\r\nSET @Searchid = (SELECT sensid FROM sensorchecks WHERE `GUID` = '430a4640-9c97-4344-bfe8-7a786b110729');\r\nINSERT INTO groupagents \r\nSELECT '' as `AgentID`,\r\n`groupid` as `GroupID`,\r\n@Searchid as `SearchID`,\r\n'ProVal - Production - AD Account Lockout Detection' as `Name`,\r\n'6' as `CheckAction`,\r\n'1' as `AlertAction`,\r\n'AD Account LockOut Detected on %COMPUTERNAME%~~~%RESULT%.!!!AD Account LockOut Detected on %COMPUTERNAME%~~~Here are the details of the user(s) who were locked out:%RESULT%.' as `AlertMessage`,\r\n'0' as `ContactID`,\r\n'900' as `interval`,\r\n'127.0.0.1' as `Where`,\r\n'7' as `What`,\r\n'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -ExecutionPolicy Bypass -Command \"$st = (Get-Date).AddMinutes(-15); $r = Get-winevent -erroraction silentlycontinue -FilterHashtable @{logname=\\'security\\'; id=4740; startTime=$st} | ForEach-Object {$ex = ([xml]$_.ToXml()).Event; $e = [ordered]@{EventDate = [DateTime]$ex.System.TimeCreated.SystemTime};$ex.EventData.ChildNodes | ForEach-Object{$e[$_.Name] = $_.'#text'};[PsCustomObject]$e}; if ($r) { $r | Select-Object  @{n=\\'EventID\\';e={\\'4740\\'}}, @{n=\\'EventDate\\';e={$_.eventdate}}, @{n=\\'Username\\';e={$_.TargetUserName}}, @{n=\\'Endpoint\\';e={$_.TargetDomainName}}, @{n=\\'Domain\\';e={$_.SubjectDomainName}}, @{n=\\'DC\\'; e={$_.SubjectUserName}} | Format-List }\"' as `DataOut`,\r\n'16' as `Comparor`,\r\n'10|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))|11|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))%7C(^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})EventID)|10|^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})EventID' as `DataIn`,\r\n'' as `IDField`,\r\n'0' as `AlertStyle`,\r\n'0' as `ScriptID`,\r\n'' as `datacollector`,\r\n'11' as `Category`,\r\n'0' as `TicketCategory`,\r\n'1' as `ScriptTarget`,\r\nCONCAT(\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\n'-',\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\n'-',\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\n'-',\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\n'-',\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\n'SUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1),\r\nSUBSTRING('abcdef0123456789', FLOOR(RAND()*16+1), 1)\r\n) as `GUID`,\r\n'root' as `UpdatedBy`,\r\n(NOW()) as `UpdateDate`\r\nFROM mastergroups m\r\nWHERE m.groupid = @Groupid\r\nAND m.groupid NOT IN (SELECT DISTINCT groupid FROM groupagents WHERE `Name` = 'ProVal - Production - AD Account Lockout Detection');\n"})}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h3,{id:"step-4",children:"Step 4"}),"\n",(0,o.jsxs)(t.p,{children:["Check the ",(0,o.jsx)(t.code,{children:"Domain Controllers"})," group and ensure that the monitor set is created and configured with the correct search.",(0,o.jsx)(t.br,{}),"\n",(0,o.jsx)(t.strong,{children:"Limit To:"})," ",(0,o.jsx)(t.code,{children:"Server Role - AD - Infrastructure Master"})]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.img,{alt:"Image 1",src:n(25426).A+"",width:"1000",height:"450"}),(0,o.jsx)(t.br,{}),"\n",(0,o.jsx)(t.img,{alt:"Image 2",src:n(573609).A+"",width:"633",height:"316"})]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h3,{id:"step-5",children:"Step 5"}),"\n",(0,o.jsxs)(t.p,{children:["Assign the required alert template. It is suggested to use ",(0,o.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"})," for the best results."]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},25426:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_1-ab795f10aff9eab351a2a4bf354e6795.png"},573609:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_2-7378042566655b9171c44c47c51cdb17.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>i});var r=n(296540);const o={},s=r.createContext(o);function a(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);