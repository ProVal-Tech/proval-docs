"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[18168],{765592:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"cwa/monitors/b582b836-52e5-4908-b154-791e0f95f7db","title":"Implement - Remote Monitor - Domain Admin Account Lockout","description":"This document outlines the steps to import an alert template and validate its execution for failures only, create a remote monitor for Domain Controllers, and ensure proper configuration and assignment of the alert template for effective monitoring.","source":"@site/docs/cwa/monitors/Implement - Remote Monitor - Domain Admin Account Lockout.md","sourceDirName":"cwa/monitors","slug":"/cwa/monitors/b582b836-52e5-4908-b154-791e0f95f7db","permalink":"/docs/cwa/monitors/b582b836-52e5-4908-b154-791e0f95f7db","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/monitors/Implement - Remote Monitor - Domain Admin Account Lockout.md","tags":[{"inline":false,"label":"Database","permalink":"/docs/tags/database","description":"Documents related to database management systems and operations"},{"inline":false,"label":"Windows","permalink":"/docs/tags/windows","description":"Documents related to Microsoft Windows operating system and its functionalities"}],"version":"current","frontMatter":{"id":"b582b836-52e5-4908-b154-791e0f95f7db","title":"Implement - Remote Monitor - Domain Admin Account Lockout","title_meta":"Implement - Remote Monitor - Domain Admin Account Lockout","keywords":["alert","template","sql","monitor","domain","controllers","configuration"],"description":"This document outlines the steps to import an alert template and validate its execution for failures only, create a remote monitor for Domain Controllers, and ensure proper configuration and assignment of the alert template for effective monitoring.","tags":["database","windows"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"HyperV - Snapshot Age  3 Days","permalink":"/docs/cwa/monitors/99c03451-d553-4cba-be15-fd19d1a922f4"},"next":{"title":"Implement - Remote Monitor - Domain Trust Relationship Check","permalink":"/docs/cwa/monitors/e2fc5d7b-d202-4511-8807-8ac000d104a1"}}');var r=o(474848),a=o(28453);const i={id:"b582b836-52e5-4908-b154-791e0f95f7db",title:"Implement - Remote Monitor - Domain Admin Account Lockout",title_meta:"Implement - Remote Monitor - Domain Admin Account Lockout",keywords:["alert","template","sql","monitor","domain","controllers","configuration"],description:"This document outlines the steps to import an alert template and validate its execution for failures only, create a remote monitor for Domain Controllers, and ensure proper configuration and assignment of the alert template for effective monitoring.",tags:["database","windows"],draft:!1,unlisted:!1},s=void 0,c={},l=[{value:"Steps to Follow",id:"steps-to-follow",level:2},{value:"1. Import the Alert Template",id:"1-import-the-alert-template",level:3},{value:"2. Validate the Script",id:"2-validate-the-script",level:3},{value:"3. Run SQL Query",id:"3-run-sql-query",level:3},{value:"4. Check Domain Controllers Group",id:"4-check-domain-controllers-group",level:3},{value:"5. Assign the Alert Template",id:"5-assign-the-alert-template",level:3}];function m(e){const t={br:"br",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"steps-to-follow",children:"Steps to Follow"}),"\n",(0,r.jsx)(t.h3,{id:"1-import-the-alert-template",children:"1. Import the Alert Template"}),"\n",(0,r.jsxs)(t.p,{children:["Import the alert template '",(0,r.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"}),"'."]}),"\n",(0,r.jsx)(t.h3,{id:"2-validate-the-script",children:"2. Validate the Script"}),"\n",(0,r.jsx)(t.p,{children:"Validate that the [CWM - Automate - Script - Ticket Creation - Computer [Failures Only]](../scripts/Ticket Creation - Computer Failures Only.md) script was imported as well and that the alert template is executing this script for failures only."}),"\n",(0,r.jsx)(t.h3,{id:"3-run-sql-query",children:"3. Run SQL Query"}),"\n",(0,r.jsx)(t.p,{children:"Run this SQL query from a RAWSQL monitor set to create and set the remote monitor on the Domain Controllers group and limit it to the server role - AD Infrastructure Master."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",children:"SET @Groupid = (SELECT Groupid FROM mastergroups WHERE `GUID` = '3ac455da-f1fb-11e1-b4ec-1231391d2d19');\r\nSET @Searchid = (SELECT sensid FROM sensorchecks WHERE `GUID` = '430a4640-9c97-4344-bfe8-7a786b110729');\r\n\r\nINSERT INTO groupagents \r\nSELECT '' as `AgentID`,\r\n`groupid` as `GroupID`,\r\n@Searchid as `SearchID`,\r\n'ProVal - Production - Domain Admin Account Lockout' as `Name`,\r\n'6' as `CheckAction`,\r\n'1' as `AlertAction`,\r\n'Doman Admin Locked Account Detected on %computername%~~~No domain admin account locked. All good.!!!Domain Admin Locked Account Detected on %computername%~~~Domain Admin Locked Account Detected on %computername%. Refer to the below detail:%RESULT%.' as `AlertMessage`,\r\n'0' as `ContactID`,\r\n'900' as `interval`,\r\n'127.0.0.1' as `Where`,\r\n'7' as `What`,\r\n'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -ExecutionPolicy Bypass -Command \"$st = (Get-Date).AddMinutes(-15); $r = Get-WinEvent -ErrorAction SilentlyContinue -FilterHashtable @{LogName = ''Security''; Id = 4740; StartTime = $st } | ForEach-Object {$ex = ([xml]$_.ToXml()).Event; $e = [ordered]@{EventDate = [DateTime]$ex.System.TimeCreated.SystemTime }; $ex.EventData.ChildNodes | ForEach-Object { $e[$_.Name] = $_.'#text' }; [PsCustomObject]$e};if ($r) {$domainAdmins = Get-ADGroupMember -Identity ''Domain Admins'' -Recursive | Select-Object -ExpandProperty SamAccountName; $lockedOutAdmins = $r | Where-Object { $domainAdmins -contains $_.TargetUserName };$lockedOutAdmins | ForEach-Object {$user = $_.TargetUserName; $lastLogin = (Get-ADUser -Identity $user -Properties LastLogonDate).LastLogonDate; $lockoutTime = $_.EventDate; $endpoint = $_.TargetDomainName; $domain = $_.SubjectDomainName; [PSCustomObject]@{Username = $user; LastLogin = $lastLogin; LockoutTime = $lockoutTime; Endpoint = $endpoint; Domain = $domain}} | Format-List}\"' as `DataOut`,\r\n'16' as `Comparor`,\r\n'10|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))|11|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))%7C(^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})Username)|10|^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})Username' as `DataIn`,\r\n'0' as `IDField`,\r\n'0' as `AlertStyle`,\r\n'0' as `ScriptID`,\r\n'' as `datacollector`,\r\n'11' as `Category`,\r\n'0' as `TicketCategory`,\r\n'1' as `ScriptTarget`,\r\nUUID() as `GUID`,\r\n'root' as `UpdatedBy`,\r\n(NOW()) as `UpdateDate`\r\nFROM mastergroups m\r\nWHERE m.groupid = @groupid\r\nAND m.groupid NOT IN (SELECT DISTINCT groupid FROM groupagents WHERE `Name` = 'ProVal - Production - Domain Admin Account Lockout')\n"})}),"\n",(0,r.jsx)(t.h3,{id:"4-check-domain-controllers-group",children:"4. Check Domain Controllers Group"}),"\n",(0,r.jsxs)(t.p,{children:["Check the ",(0,r.jsx)(t.code,{children:"Domain Controllers"})," group and ensure that the monitor set is created and configured with the correct search.",(0,r.jsx)(t.br,{}),"\n",(0,r.jsx)(t.strong,{children:"Limit To:"})," ",(0,r.jsx)(t.code,{children:"Server Role - AD - Infrastructure Master"})]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.img,{alt:"Image 1",src:o(63005).A+"",width:"1000",height:"450"}),(0,r.jsx)(t.br,{}),"\n",(0,r.jsx)(t.img,{alt:"Image 2",src:o(765446).A+"",width:"662",height:"278"})]}),"\n",(0,r.jsx)(t.h3,{id:"5-assign-the-alert-template",children:"5. Assign the Alert Template"}),"\n",(0,r.jsxs)(t.p,{children:["Assign the required alert template. It is suggested to use '",(0,r.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"}),"' for the best results."]})]})}function d(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},63005:(e,t,o)=>{o.d(t,{A:()=>n});const n=o.p+"assets/images/image_1-ab795f10aff9eab351a2a4bf354e6795.png"},765446:(e,t,o)=>{o.d(t,{A:()=>n});const n=o.p+"assets/images/image_2-75f2f6e03c9481e931d94eb924835d32.png"},28453:(e,t,o)=>{o.d(t,{R:()=>i,x:()=>s});var n=o(296540);const r={},a=n.createContext(r);function i(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);