"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[29877],{183341:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>n,metadata:()=>c,toc:()=>l});const c=JSON.parse('{"id":"cwa/scripts/18fbde09-500a-41a4-bad0-c37b85429926","title":"Active Directory - Privilege Escalation Attack Mitigation","description":"This document outlines a PowerShell script designed to verify the installation of necessary patches to mitigate and detect Active Directory privilege escalation attacks. It checks for the presence of specific patches, monitors registry settings, and identifies non-compliant computer accounts, ultimately enhancing security compliance for domain controllers.","source":"@site/docs/cwa/scripts/Active Directory - Privilege Escalation Attack Mitigation.md","sourceDirName":"cwa/scripts","slug":"/cwa/scripts/18fbde09-500a-41a4-bad0-c37b85429926","permalink":"/proval-docs/docs/cwa/scripts/18fbde09-500a-41a4-bad0-c37b85429926","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/scripts/Active Directory - Privilege Escalation Attack Mitigation.md","tags":[{"inline":false,"label":"Active Directory","permalink":"/proval-docs/docs/tags/active-directory","description":"Documents related to Active Directory services and management"},{"inline":false,"label":"Compliance","permalink":"/proval-docs/docs/tags/compliance","description":"Documents related to compliance with industry standards and regulations"},{"inline":false,"label":"Registry","permalink":"/proval-docs/docs/tags/registry","description":"Documents concerning system registry management and troubleshooting"},{"inline":false,"label":"Security","permalink":"/proval-docs/docs/tags/security","description":"Documents discussing security measures and practices for IT systems"}],"version":"current","frontMatter":{"id":"18fbde09-500a-41a4-bad0-c37b85429926","title":"Active Directory - Privilege Escalation Attack Mitigation","title_meta":"Active Directory - Privilege Escalation Attack Mitigation","keywords":["active-directory","patches","security","registry","compliance"],"description":"This document outlines a PowerShell script designed to verify the installation of necessary patches to mitigate and detect Active Directory privilege escalation attacks. It checks for the presence of specific patches, monitors registry settings, and identifies non-compliant computer accounts, ultimately enhancing security compliance for domain controllers.","tags":["active-directory","compliance","registry","security"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"Active Directory - Plugin User Account - CreateUpdate","permalink":"/proval-docs/docs/cwa/scripts/ea1aca74-77ee-4387-91f2-57adb5822737"},"next":{"title":"Activity Logging Reporting DV, Global","permalink":"/proval-docs/docs/cwa/scripts/53f4f86f-0936-40ef-ac65-7287f74d7f65"}}');var s=i(474848),r=i(28453);const n={id:"18fbde09-500a-41a4-bad0-c37b85429926",title:"Active Directory - Privilege Escalation Attack Mitigation",title_meta:"Active Directory - Privilege Escalation Attack Mitigation",keywords:["active-directory","patches","security","registry","compliance"],description:"This document outlines a PowerShell script designed to verify the installation of necessary patches to mitigate and detect Active Directory privilege escalation attacks. It checks for the presence of specific patches, monitors registry settings, and identifies non-compliant computer accounts, ultimately enhancing security compliance for domain controllers.",tags:["active-directory","compliance","registry","security"],draft:!1,unlisted:!1},o=void 0,a={},l=[{value:"Summary",id:"summary",level:2},{value:"Sample Run",id:"sample-run",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Variables",id:"variables",level:2},{value:"Process",id:"process",level:2},{value:"Output",id:"output",level:2}];function d(e){const t={a:"a",br:"br",code:"code",h2:"h2",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(t.p,{children:["The script is designed to verify the installation of all necessary patches to mitigate and detect Active Directory privilege escalation attacks. Additionally, it searches for computer accounts with non-compliant ",(0,s.jsx)(t.code,{children:"sAMAccountName"})," values and ensures the presence of the ",(0,s.jsx)(t.code,{children:"HKEY_LOCAL_MACHINE/System/CurrentControlSet/Services/Kdc/PacRequestorEnforcement"})," registry key with a value of 1."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Intended Target:"})," Domain Controllers",(0,s.jsx)(t.br,{}),"\n",(0,s.jsx)(t.strong,{children:"Time Saved by Automation:"})," 30 Minutes."]}),"\n",(0,s.jsx)(t.h2,{id:"sample-run",children:"Sample Run"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Sample Run",src:i(113380).A+"",width:"484",height:"350"})}),"\n",(0,s.jsx)(t.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://proval.itglue.com/DOC-5078775-8930310",children:"Workaround - Active Directory privilege escalation attack [SCRIPT]"})}),"\n",(0,s.jsx)(t.h2,{id:"variables",children:"Variables"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"@Output@"}),": Stores the PowerShell result of the script verifying the installation of the relevant patches."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"@Missing_Patches@"}),": KBID of the superseded patches that need to be installed on the concerned computer."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"@ncsam@"}),": Stores the names of the computer accounts with non-compliant ",(0,s.jsx)(t.code,{children:"sAMAccountName"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"process",children:"Process"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Step 1:"})," The script checks for the installation of the patches needed to stop/restrict Active Directory privilege escalation attacks. As superseded versions of each patch are released, the script may need updates to account for these changes. Currently, it looks for the following patches, with one patch from each line required for the concerned Operating System:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-us/topic/december-14-2021-kb5008263-monthly-rollup-513a39f5-b624-4214-b2be-b93f5a775e12",children:"KB5008263"}),", ",(0,s.jsx)(t.a,{href:"#",children:"KB5007247"}),": Server 2012 R2"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-us/topic/december-14-2021-kb5008277-monthly-rollup-f6678266-b1fb-474e-9cf1-cf60fa8faa54",children:"KB5008277"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-us/topic/november-9-2021-kb5007260-monthly-rollup-eea1738a-38d1-424b-8d73-d9e30ce28e1a",children:"KB5007260"}),": Server 2012"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/december-14-2021-kb5008244-monthly-rollup-d128e47c-8828-4f0d-9d30-571bb1bc1c5f",children:"KB5008244"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007236-monthly-rollup-bb3700cd-168a-4834-a517-35bd43498b7d",children:"KB5007236"}),": Server 2008 R2"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/december-14-2021-kb5008274-monthly-rollup-e7eed5a2-1154-4af6-a3ec-1db61d66f967",children:"KB5008274"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007263-monthly-rollup-cbefd1e8-7bdc-4a3f-98f5-7d9f20e5fa0b",children:"KB5007263"}),": Server 2008"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/december-14-2021-kb5008207-os-build-14393-4825-35421e45-96b3-4585-9faa-02576d813e7a",children:"KB5008207"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-14-2021-kb5008601-os-build-14393-4771-out-of-band-c8cd33ce-3d40-4853-bee4-a7cc943582b9",children:"KB5008601"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007192-os-build-14393-4770-f534a33a-ed00-4bd2-8248-9424c53e9bde",children:"KB5007192"}),": Server 2016"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/december-14-2021-kb5008218-os-build-17763-2366-0d9c500d-6e71-4cb4-99e2-416655622769",children:"KB5008218"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-14-2021-kb5008602-os-build-17763-2305-out-of-band-8583a8a3-ebed-4829-b285-356fb5aaacd7",children:"KB5008602"}),", ",(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007206-os-build-17763-2300-c63b76fa-a9b4-4685-b17c-7d866bb50e48",children:"KB5007206"}),": Server 2019"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007255-security-only-update-10532701-72af-4061-a138-a5f85685eef9",children:"KB5007255"}),": Server 2012 R2"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007245-security-only-update-f1e7ded4-9dfb-4625-8d34-70d8c1d42eda",children:"KB5007245"}),": Server 2012"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007233-security-only-update-4276b400-6317-4e0c-a830-ac375aec983c",children:"KB5007233"}),": Server 2008 R2"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://support.microsoft.com/en-gb/topic/november-9-2021-kb5007246-security-only-update-99e6a0cc-f6cc-4887-9219-021707060ebb",children:"KB5007246"}),": Server 2008"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Step 2:"}),' It will add the KBID of the compulsory and missing updates to the "Missing Patches" EDF of the concerned computer.']}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Step 3:"})," The script will check the status of the ",(0,s.jsx)(t.code,{children:"HKEY_LOCAL_MACHINE/System/CurrentControlSet/Services/Kdc/PacRequestorEnforcement"})," registry key and will add/update the registry key if the value is not already set to 1 or 2."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Step 4:"})," Finally, it will check for potentially vulnerable computer accounts and update those names in the EDFs."]}),"\n",(0,s.jsx)(t.p,{children:"The script will save information to the following EDFs based on the output of the script:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"KB5008602 Status"}),"\n",(0,s.jsx)(t.li,{children:"KB5008380 Status"}),"\n",(0,s.jsx)(t.li,{children:"KB5008102 Status"}),"\n",(0,s.jsx)(t.li,{children:"Missing Patches"}),"\n",(0,s.jsx)(t.li,{children:"CVE-2021-42287 Workaround"}),"\n",(0,s.jsx)(t.li,{children:"Non-compliant sAMAccountName"}),"\n",(0,s.jsx)(t.li,{children:"Non-compliant UAC sAMAccountType"}),"\n",(0,s.jsx)(t.li,{children:"Information Update Time"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["These EDFs are also presented in the dataview ",(0,s.jsx)(t.a,{href:"https://proval.itglue.com/DOC-5078775-8930310",children:"Workaround - Active Directory privilege escalation attack [SCRIPT]"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"output",children:"Output"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Extra Data Fields"}),"\n",(0,s.jsx)(t.li,{children:"Dataview"}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},113380:(e,t,i)=>{i.d(t,{A:()=>c});const c=i.p+"assets/images/image_1-ee5c4247db8ab86f793658ca683b3841.png"},28453:(e,t,i)=>{i.d(t,{R:()=>n,x:()=>o});var c=i(296540);const s={},r=c.createContext(s);function n(e){const t=c.useContext(r);return c.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:n(e.components),c.createElement(r.Provider,{value:t},e.children)}}}]);