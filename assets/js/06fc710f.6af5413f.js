"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[95462],{302756:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"cwa/monitors/7f37dfc1-5f0a-4f7d-bf9f-631ea653a74d","title":"Import- AD Recycle Bin State Check","description":"This document provides a step-by-step guide on how to enable the Active Directory Recycle Bin feature in ConnectWise Automate. It includes importing the necessary alert template, running SQL queries to set up the feature, and configuring the remote monitor for Domain Controllers.","source":"@site/docs/cwa/monitors/Import- AD Recycle Bin State Check.md","sourceDirName":"cwa/monitors","slug":"/cwa/monitors/7f37dfc1-5f0a-4f7d-bf9f-631ea653a74d","permalink":"/docs/cwa/monitors/7f37dfc1-5f0a-4f7d-bf9f-631ea653a74d","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/monitors/Import- AD Recycle Bin State Check.md","tags":[{"inline":false,"label":"Database","permalink":"/docs/tags/database","description":"Documents related to database management systems and operations"},{"inline":false,"label":"Setup","permalink":"/docs/tags/setup","description":"Documents on setting up software and hardware configurations"}],"version":"current","frontMatter":{"id":"7f37dfc1-5f0a-4f7d-bf9f-631ea653a74d","title":"Import- AD Recycle Bin State Check","title_meta":"Import- AD Recycle Bin State Check","keywords":["ad","recycle","bin","connectwise","automate","sql","monitor"],"description":"This document provides a step-by-step guide on how to enable the Active Directory Recycle Bin feature in ConnectWise Automate. It includes importing the necessary alert template, running SQL queries to set up the feature, and configuring the remote monitor for Domain Controllers.","tags":["database","setup"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"Import - Remote Monitor - Veeam Service Monitor","permalink":"/docs/cwa/monitors/dce82a22-77ba-4133-90d9-78a0a1b88412"},"next":{"title":"Import- Backup Exec - No successful backups in 3 days","permalink":"/docs/cwa/monitors/1b34e236-7235-4dc1-b4d2-fdd120e75f47"}}');var o=n(474848),i=n(28453);const a={id:"7f37dfc1-5f0a-4f7d-bf9f-631ea653a74d",title:"Import- AD Recycle Bin State Check",title_meta:"Import- AD Recycle Bin State Check",keywords:["ad","recycle","bin","connectwise","automate","sql","monitor"],description:"This document provides a step-by-step guide on how to enable the Active Directory Recycle Bin feature in ConnectWise Automate. It includes importing the necessary alert template, running SQL queries to set up the feature, and configuring the remote monitor for Domain Controllers.",tags:["database","setup"],draft:!1,unlisted:!1},s=void 0,c={},l=[{value:"Step 1",id:"step-1",level:2},{value:"Step 2",id:"step-2",level:2},{value:"Step 3",id:"step-3",level:2},{value:"Step 4",id:"step-4",level:2},{value:"Step 5",id:"step-5",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h2,{id:"step-1",children:"Step 1"}),"\n",(0,o.jsx)(t.p,{children:"Import the Alert Template '\u25b3 Custom - Execute Script - AD - Enable AD Recycle Bin'"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Validate that the ",(0,o.jsx)(t.a,{href:"/docs/cwa/scripts/e80d5873-304e-4b12-b52c-b608a7715a9f",children:"AD - Enable AD Recycle Bin"})," script was imported as well."]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"step-2",children:"Step 2"}),"\n",(0,o.jsx)(t.p,{children:"Run the SQL Query to import the 'AD Domain Recycle Bin Feature' role if it's not already available in the environment."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"INSERT IGNORE INTO RoleDefinitions( `RoleName`, `RoleType`, `RoleSubType`, `DetectionString`, `ComparisonOperator`, `ComparisonResult`, `SerialKeyString`, `ProductKeyString`, `SearchId`, `IsSupport`, `ParentRoleDefinitionGuid`, `IsRemote`, `RoleDetectionGuid`, `OSType` ) \r\nVALUES('AD Domain Recycle Bin Feature', 'Domain Controller', 'Role', '{%@powershell.exe \"Get-ADOptionalFeature -Identity \\'Recycle Bin Feature\\'|select -exp enabledscopes|format-list;if ($enabledScopes){Write-Output -InputObject \\'Enabled\\'}else{Write-Output -InputObject \\'Disabled\\'}\"@%}', 'eq', 'Enabled', '', '', 0, 0, '', 1, 'c6de5dcd-7ef6-11e8-b703-000c295e5f17', 1);\n"})}),"\n",(0,o.jsx)(t.h2,{id:"step-3",children:"Step 3"}),"\n",(0,o.jsx)(t.p,{children:"Run this SQL query from a RAWSQL monitor set to import the required search."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"INSERT INTO `sensorchecks` (`Name`, `SQL`, `QueryType`, `ListDATA`, `FolderID`, `GUID`, `SearchXML`) \r\nSELECT\r\n    'DC without Recycle Bin',\r\n    'Select DISTINCT Computers.ComputerID, Clients.Name as `Client Name`, Computers.Name as `Computer Name`, Computers.Domain, Computers.UserName as `Username`, Computers.ComputerID\\r\\nFrom Computers, Clients\\r\\nWhere Computers.ClientID = Clients.ClientID\\r\\n and ((Computers.ComputerID in (SELECT DISTINCT computerid FROM computers WHERE computerid IN (SELECT DISTINCT computerid FROM computerroledefinitions WHERE roledefinitionid = (SELECT Roledefinitionid FROM `roledefinitions` WHERE rolename=\\'AD Infrastructure Master\\') AND CurrentlyDetected =1) AND computerid NOT IN (SELECT DISTINCT computerid FROM computerroledefinitions WHERE roledefinitionid = (SELECT Roledefinitionid FROM `roledefinitions` WHERE roledetectionguid = \\'c6de5dcd-7ef6-11e8-b703-000c295e5f17\\') AND CurrentlyDetected =1))))',\r\n    '4',\r\n    'Computer ID||<=|*(SELECT DISTINCT computerid FROM computers WHERE computerid IN (SELECT DISTINCT computerid FROM computerroledefinitions WHERE roledefinitionid = (SELECT Roledefinitionid FROM `roledefinitions` WHERE rolename=\\'AD Infrastructure Master\\') AND CurrentlyDetected =1) AND computerid NOT IN (SELECT DISTINCT computerid FROM computerroledefinitions WHERE roledefinitionid = (SELECT Roledefinitionid FROM `roledefinitions` WHERE roledetectionguid = \\'c6de5dcd-7ef6-11e8-b703-000c295e5f17\\') AND CurrentlyDetected =1))|=||=|^Select|||||||^',\r\n    '0',\r\n    'a903f855-1c5d-4ac2-9b56-35ff1b189f9c',\r\n    ''\r\nFROM\r\n    (SELECT MIN(computerid) FROM computers) a\r\nWHERE \r\n    (SELECT COUNT(*) FROM SensorChecks WHERE `GUID` = 'a903f855-1c5d-4ac2-9b56-35ff1b189f9c') = 0\n"})}),"\n",(0,o.jsx)(t.h2,{id:"step-4",children:"Step 4"}),"\n",(0,o.jsx)(t.p,{children:"Run this SQL query from a RAWSQL monitor set to create and set up the remote monitor on the Domain Controllers group."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sql",children:"SET @Groupid= (SELECT Groupid FROM mastergroups WHERE `GUID` = '3ac455da-f1fb-11e1-b4ec-1231391d2d19');\r\nSET @searchid = (SELECT sensid FROM sensorchecks WHERE `GUID` = 'a903f855-1c5d-4ac2-9b56-35ff1b189f9c');\r\nSET @Alertaction= (SELECT alertactionid FROM alerttemplate WHERE `GUID` = '0ffdefcc-885e-4b80-bf03-41c146029ec6');\r\nINSERT INTO \r\n    groupagents\r\nSELECT \r\n    '' as `AgentID`,\r\n    `groupid` as `GroupID`,\r\n    @Searchid as `SearchID`,\r\n    'ProVal - Production - AD Recycle Bin State Check' as `Name`,\r\n    '6' as `CheckAction`,\r\n    @Alertaction as `AlertAction`,\r\n    '[No Alerting]~~~%STATUS% on %CLIENTNAME%\\\\%COMPUTERNAME% at %LOCATIONNAME% for %FIELDNAME% result %RESULT%.!!![No Alerting]~~~%STATUS% on %CLIENTNAME%\\\\%COMPUTERNAME% at %LOCATIONNAME% for %FIELDNAME% result %RESULT%.' as `AlertMessage`,\r\n    '0' as `ContactID`,\r\n    '86400' as `interval`,\r\n    '127.0.0.1' as `Where`,\r\n    '7' as `What`,\r\n    'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -ExecutionPolicy Bypass -Command \"if ((Get-Service -Name \\'ADWS\\' -Erroraction SilentlyContinue).Status -eq \\'Running\\') {Import-module ActiveDirectory;$Result = Get-ADOptionalFeature -filter * | Select-Object -ExpandProperty EnabledScopes;if($Result){Write-Output \\'Already AD Recycle Bin Enabled\\'}else{Write-Output \\'AD Recycle Bin Not Enabled\\'}}\"' as `DataOut`,\r\n    '16' as `Comparor`,\r\n    '10|^(([\\\\r\\\\n]{1,})%7C(OK)%7C(\\\\s{1,}))$%7C(^$)%7C(Already AD Recycle Bin Enabled)|11|(^(([\\\\r\\\\n]{1,})%7C(OK)%7C(\\\\s{1,}))$%7C(^$)%7C(Already AD Recycle Bin Enabled))%7C(^([\\\\r\\\\n]{0,}AD Recycle Bin Not Enabled[\\\\r\\\\n]{0,})$)|10|^([\\\\r\\\\n]{0,}AD Recycle Bin Not Enabled[\\\\r\\\\n]{0,})$' as `DataIn`,\r\n    '' as `IDField`,\r\n    '1' as `AlertStyle`,\r\n    '0' as `ScriptID`,\r\n    '' as `datacollector`,\r\n    '16' as `Category`,\r\n    '0' as `TicketCategory`,\r\n    '1' as `ScriptTarget`,\r\n    UUID() as `GUID`,\r\n    'root' as `UpdatedBy`,\r\n    (NOW()) as `UpdateDate`\r\nFROM \r\n    mastergroups m\r\nWHERE \r\n    m.groupid= @Groupid\r\n    AND m.groupid NOT IN (SELECT DISTINCT groupid FROM groupagents WHERE `Name` = 'ProVal - Production - AD Recycle Bin State Check')\n"})}),"\n",(0,o.jsx)(t.h2,{id:"step-5",children:"Step 5"}),"\n",(0,o.jsxs)(t.p,{children:["Navigate to the ",(0,o.jsx)(t.code,{children:"Domain Controllers"})," group and validate the presence of the monitor set."]})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>s});var r=n(296540);const o={},i=r.createContext(o);function a(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);