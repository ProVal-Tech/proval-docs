"use strict";(self.webpackChunkproval_docs=self.webpackChunkproval_docs||[]).push([[31467],{518613:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"cwa/monitors/a24b00c5-49d4-4a2b-9090-a2716b56cf47","title":"Domain Admin Account Lockout","description":"This document outlines the configuration of a remote monitor designed to detect when the domain admin account is locked. It includes details on check actions, dependencies, target servers, ticketing information, and implementation steps for effective monitoring and alerting.","source":"@site/docs/cwa/monitors/Domain Admin Account Lockout.md","sourceDirName":"cwa/monitors","slug":"/cwa/monitors/a24b00c5-49d4-4a2b-9090-a2716b56cf47","permalink":"/docs/cwa/monitors/a24b00c5-49d4-4a2b-9090-a2716b56cf47","draft":false,"unlisted":false,"editUrl":"https://github.com/proval-tech/proval-docs/tree/main/docs/cwa/monitors/Domain Admin Account Lockout.md","tags":[{"inline":false,"label":"Active Directory","permalink":"/docs/tags/active-directory","description":"Documents related to Active Directory services and management"}],"version":"current","frontMatter":{"id":"a24b00c5-49d4-4a2b-9090-a2716b56cf47","title":"Domain Admin Account Lockout","title_meta":"Domain Admin Account Lockout","keywords":["monitor","domain","admin","lockout","ticket","alert"],"description":"This document outlines the configuration of a remote monitor designed to detect when the domain admin account is locked. It includes details on check actions, dependencies, target servers, ticketing information, and implementation steps for effective monitoring and alerting.","tags":["active-directory"],"draft":false,"unlisted":false},"sidebar":"contentSidebar","previous":{"title":"Disk - Predictive Failure","permalink":"/docs/cwa/monitors/81638d59-3335-4464-af10-25f37ed41402"},"next":{"title":"Domain Trust Relationship Check","permalink":"/docs/cwa/monitors/bf518e9f-f93c-451b-a38a-5fc3472cc6f4"}}');var i=n(474848),o=n(28453);const a={id:"a24b00c5-49d4-4a2b-9090-a2716b56cf47",title:"Domain Admin Account Lockout",title_meta:"Domain Admin Account Lockout",keywords:["monitor","domain","admin","lockout","ticket","alert"],description:"This document outlines the configuration of a remote monitor designed to detect when the domain admin account is locked. It includes details on check actions, dependencies, target servers, ticketing information, and implementation steps for effective monitoring and alerting.",tags:["active-directory"],draft:!1,unlisted:!1},s=void 0,c={},d=[{value:"Summary",id:"summary",level:2},{value:"Details",id:"details",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Target",id:"target",level:2},{value:"Ticketing",id:"ticketing",level:2},{value:"Implementation",id:"implementation",level:2},{value:"1. Import the Alert Template",id:"1-import-the-alert-template",level:3},{value:"2. Validate the Script",id:"2-validate-the-script",level:3},{value:"3. Run SQL Query",id:"3-run-sql-query",level:3},{value:"4. Check Domain Controllers Group",id:"4-check-domain-controllers-group",level:3},{value:"5. Assign the Alert Template",id:"5-assign-the-alert-template",level:3}];function l(e){const t={a:"a",br:"br",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(t.p,{children:"This remote monitor is configured to detect when the domain admin account is locked. It checks every 15 minutes and creates a ticket for the partner to review, providing complete details."}),"\n",(0,i.jsx)(t.h2,{id:"details",children:"Details"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:'Suggested "Limit to"'}),": Server Role - AD - Infrastructure Master",(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.strong,{children:"Suggested Alert Style"}),": Continuous",(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.strong,{children:"Suggested Alert Template"}),": ",(0,i.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Check Action"}),(0,i.jsx)(t.th,{children:"Server Address"}),(0,i.jsx)(t.th,{children:"Check Type"}),(0,i.jsx)(t.th,{children:"Check Value"}),(0,i.jsx)(t.th,{children:"Comparator"}),(0,i.jsx)(t.th,{children:"Interval"})]})}),(0,i.jsx)(t.tbody,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"System"}),(0,i.jsx)(t.td,{children:"127.0.0.1"}),(0,i.jsx)(t.td,{children:"Run File"}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.strong,{children:"REDACTED"})}),(0,i.jsx)(t.td,{children:"State Based"}),(0,i.jsx)(t.td,{children:"900"})]})})]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"State Conditions:"}),(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.img,{alt:"State Conditions",src:n(981841).A+"",width:"1000",height:"94"})]}),"\n",(0,i.jsx)(t.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"/docs/cwa/scripts/e14bf501-f10d-44d7-a19a-2284fd5c5cc9",children:"CWM - Automate - Script - Ticket Creation - Computer [Failures Only]"}),(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"})]}),"\n",(0,i.jsx)(t.h2,{id:"target",children:"Target"}),"\n",(0,i.jsxs)(t.p,{children:["Domain Controllers",(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.img,{alt:"Target Image",src:n(857178).A+"",width:"1000",height:"450"}),(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.img,{alt:"Target Image",src:n(78755).A+"",width:"662",height:"278"})]}),"\n",(0,i.jsxs)(t.p,{children:["The monitor set should be limited to the ",(0,i.jsx)(t.code,{children:"Server Roles/Server Role - AD - Infrastructure Master"})," search."]}),"\n",(0,i.jsx)(t.h2,{id:"ticketing",children:"Ticketing"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Subject:"}),(0,i.jsx)(t.br,{}),"\n","Domain Admin Locked Account Detected on %computername%"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Body:"}),(0,i.jsx)(t.br,{}),"\n","Domain Admin Locked Account Detected on %computername%. Refer to the below detail:",(0,i.jsx)(t.br,{}),"\n","%RESULT%."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Reference Ticket:"}),(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.img,{alt:"Reference Ticket",src:n(148588).A+"",width:"1000",height:"433"})]}),"\n",(0,i.jsx)(t.h2,{id:"implementation",children:"Implementation"}),"\n",(0,i.jsx)(t.h3,{id:"1-import-the-alert-template",children:"1. Import the Alert Template"}),"\n",(0,i.jsxs)(t.p,{children:["Import the alert template '",(0,i.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"}),"'."]}),"\n",(0,i.jsx)(t.h3,{id:"2-validate-the-script",children:"2. Validate the Script"}),"\n",(0,i.jsx)(t.p,{children:"Validate that the [CWM - Automate - Script - Ticket Creation - Computer [Failures Only]](../scripts/Ticket Creation - Computer Failures Only.md) script was imported as well and that the alert template is executing this script for failures only."}),"\n",(0,i.jsx)(t.h3,{id:"3-run-sql-query",children:"3. Run SQL Query"}),"\n",(0,i.jsx)(t.p,{children:"Run this SQL query from a RAWSQL monitor set to create and set the remote monitor on the Domain Controllers group and limit it to the server role - AD Infrastructure Master."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SET @Groupid = (SELECT Groupid FROM mastergroups WHERE `GUID` = '3ac455da-f1fb-11e1-b4ec-1231391d2d19');\r\nSET @Searchid = (SELECT sensid FROM sensorchecks WHERE `GUID` = '430a4640-9c97-4344-bfe8-7a786b110729');\r\n\r\nINSERT INTO groupagents \r\nSELECT '' as `AgentID`,\r\n`groupid` as `GroupID`,\r\n@Searchid as `SearchID`,\r\n'ProVal - Production - Domain Admin Account Lockout' as `Name`,\r\n'6' as `CheckAction`,\r\n'1' as `AlertAction`,\r\n'Doman Admin Locked Account Detected on %computername%~~~No domain admin account locked. All good.!!!Domain Admin Locked Account Detected on %computername%~~~Domain Admin Locked Account Detected on %computername%. Refer to the below detail:%RESULT%.' as `AlertMessage`,\r\n'0' as `ContactID`,\r\n'900' as `interval`,\r\n'127.0.0.1' as `Where`,\r\n'7' as `What`,\r\n'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -ExecutionPolicy Bypass -Command \"$st = (Get-Date).AddMinutes(-15); $r = Get-WinEvent -ErrorAction SilentlyContinue -FilterHashtable @{LogName = ''Security''; Id = 4740; StartTime = $st } | ForEach-Object {$ex = ([xml]$_.ToXml()).Event; $e = [ordered]@{EventDate = [DateTime]$ex.System.TimeCreated.SystemTime }; $ex.EventData.ChildNodes | ForEach-Object { $e[$_.Name] = $_.\\'#text\\' }; [PsCustomObject]$e};if ($r) {$domainAdmins = Get-ADGroupMember -Identity ''Domain Admins'' -Recursive | Select-Object -ExpandProperty SamAccountName; $lockedOutAdmins = $r | Where-Object { $domainAdmins -contains $_.TargetUserName };$lockedOutAdmins | ForEach-Object {$user = $_.TargetUserName; $lastLogin = (Get-ADUser -Identity $user -Properties LastLogonDate).LastLogonDate; $lockoutTime = $_.EventDate; $endpoint = $_.TargetDomainName; $domain = $_.SubjectDomainName; [PSCustomObject]@{Username = $user; LastLogin = $lastLogin; LockoutTime = $lockoutTime; Endpoint = $endpoint; Domain = $domain}} | Format-List}\"' as `DataOut`,\r\n'16' as `Comparor`,\r\n'10|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))|11|((^((OK){0,}(\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})$)%7C(^$))%7C(^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})Username)|10|^((\\\\r\\\\n){0,}[\\\\r\\\\n]{0,}\\\\s{0,})Username' as `DataIn`,\r\n'0' as `IDField`,\r\n'0' as `AlertStyle`,\r\n'0' as `ScriptID`,\r\n'' as `datacollector`,\r\n'11' as `Category`,\r\n'0' as `TicketCategory`,\r\n'1' as `ScriptTarget`,\r\nUUID() as `GUID`,\r\n'root' as `UpdatedBy`,\r\n(NOW()) as `UpdateDate`\r\nFROM mastergroups m\r\nWHERE m.groupid = @groupid\r\nAND m.groupid NOT IN (SELECT DISTINCT groupid FROM groupagents WHERE `Name` = 'ProVal - Production - Domain Admin Account Lockout')\n"})}),"\n",(0,i.jsx)(t.h3,{id:"4-check-domain-controllers-group",children:"4. Check Domain Controllers Group"}),"\n",(0,i.jsxs)(t.p,{children:["Check the ",(0,i.jsx)(t.code,{children:"Domain Controllers"})," group and ensure that the monitor set is created and configured with the correct search.",(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.strong,{children:"Limit To:"})," ",(0,i.jsx)(t.code,{children:"Server Role - AD - Infrastructure Master"})]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.img,{alt:"Image 1",src:n(63005).A+"",width:"1000",height:"450"}),(0,i.jsx)(t.br,{}),"\n",(0,i.jsx)(t.img,{alt:"Image 2",src:n(765446).A+"",width:"662",height:"278"})]}),"\n",(0,i.jsx)(t.h3,{id:"5-assign-the-alert-template",children:"5. Assign the Alert Template"}),"\n",(0,i.jsxs)(t.p,{children:["Assign the required alert template. It is suggested to use '",(0,i.jsx)(t.code,{children:"\u25b3 Custom - Ticket Creation Computer - Failures Only"}),"' for the best results."]})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},981841:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_1-568c34e6052b773b9f20644189af0291.png"},857178:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_2-ab795f10aff9eab351a2a4bf354e6795.png"},78755:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_3-67bbfde2c6a5794d9f6f9ab90a751e3a.png"},148588:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_4-1d089e37220e784c6952ebf9445a9a74.png"},63005:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_1-ab795f10aff9eab351a2a4bf354e6795.png"},765446:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/image_2-75f2f6e03c9481e931d94eb924835d32.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>s});var r=n(296540);const i={},o=r.createContext(i);function a(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);