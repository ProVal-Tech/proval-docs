---
id: 'f6426cb7-b51d-4acb-a602-8fb620474a97'
title: 'Backup and Remove/Restore Registry Key'
title_meta: 'Backup and Remove/Restore Registry Key'
keywords: ['backup', 'restore', 'registry', 'windows', 'search', 'vulnerability']
description: 'This document provides a detailed overview of a script that backs up, removes, or restores the registry key HKEY_CLASSES_ROOT//search-ms. It outlines the script’s functionality, dependencies, and processes involved in executing the script, including options for manual execution and ticket creation for failures.'
tags: ['backup', 'registry', 'vulnerability', 'windows']
draft: false
unlisted: false
---
## Summary

This script backs up and removes or restores the following registry key:  
HKEY CLASSES ROOT/search-ms  
Key backup location:  
"C:/Windows/LTSvc/Packages/SearchMSRegDirectory"  

This Script is automatically executed by the “[ProVal - Development - Workaround - Windows Search Protocol Vulnerability [G]](https://proval.itglue.com/DOC-5078775-10080562)” Monitor.  

This script can also be run manually. It will give you the option to pass the value for the parameter "Restore" if you run it manually. The "HKEY CLASSES ROOT/search-ms" key will be restored if the argument is set to 1. The script's default behavior is to attempt to export and delete the registry file. The script can create a ticket for failure as well, but to enable the ticketing feature you need to update the value of the Global Variable Ticket to 1. The script's default behavior is to not generate any ticket.

Apart from this, it saves the final result to a script state, "Search-MS Registry Status" to display the data in the “[Windows Search Protocol Registry Key Audit [Script][Role]](https://proval.itglue.com/DOC-5078775-10080544)” dataview.  

Also, the script will import all the contents of the solution for its first run.

## Sample Run

Leave the Restore field blank to remove the registry key:  
![Remove Registry Key](../../../static/img/Workaround---Windows-Search-Protocol-Vulnerability/image_1.png)  

Set the Restore to 1 for Restoring the registry keys:  
![Restore Registry Key](../../../static/img/Workaround---Windows-Search-Protocol-Vulnerability/image_2.png)  

## Dependencies

- [Search-MS Registry Key](https://proval.itglue.com/DOC-5078775-10080552)
- [ProVal - Development - Workaround - Windows Search Protocol Vulnerability [G]](https://proval.itglue.com/DOC-5078775-10080562)
- [Windows Search Protocol Vulnerability - Workarounds](https://proval.itglue.com/DOC-5078775-10080462)

## Variables

| Name     | Description                                                                                     |
|----------|-------------------------------------------------------------------------------------------------|
| OutCome  | Store the Output of the PowerShell scripts being executed to perform the necessary action.     |
| Tickid   | Variable for retrieving and storing the ticketid of an existing failure ticket.                 |

#### Global Parameters

| Name     | Example    | Required | Description                                                  |
|----------|------------|----------|--------------------------------------------------------------|
| Ticketid | 1 or 0    | False    | Set it to 1 to make the script create tickets for the failures. |

#### User Parameters

| Name     | Example                   | Required | Description                     |
|----------|---------------------------|----------|---------------------------------|
| Restore  | 1 or leave it blank       | False    | 1 to use the script to restore the key |

#### Script States

| Name                       | Example                                    | Description                             |
|----------------------------|--------------------------------------------|-----------------------------------------|
| search-ms Registry Status  | BackedUp And Removed, Failed to Remove, Restored, Failed to Restore | OutCome of the recent operation performed |

## Process

Step 1: Imports all the parts to the solution.  
Step 2: Checks if it is called to Restore or to Remove the registry key.  

### For Backup and Restore.

Step 1: Clears the script state, "Search-MS Registry Status".  
Step 2: Executes the PowerShell Script to take the backup of the registry key and to Remove the key.  
Step 3: Verifies the OutCome of the PowerShell and proceeds accordingly.  
Step 4: For success, it will set the script state as "BackedUp And Removed," and exit.  
Step 5: For the failure, it will set the script state as "Failed to Remove", and checks whether if ticket creation is enabled or not.  
Step 6: If the ticket creation is enabled, it will look for the already existing ticket and add a comment to that otherwise will create a ticket if ticket does not exist.  
Step 7: Exit with success for the success and Exit with Failures for any failures.  

### For Restore.

Step 1: Clears the script state, "Search-MS Registry Status".  
Step 2: Executes the PowerShell Script to Restore the key.  
Step 3: Verifies the OutCome of the PowerShell and proceeds accordingly.  
Step 4: For success, it will set the script state as "Restored" and exit.  
Step 5: For the failure, it will set the script state as "Failed to Restore", and checks whether if ticket creation is enabled or not.  
Step 6: If the ticket creation is enabled, it will look for the already existing ticket and add a comment to that otherwise will create a ticket if ticket does not exist.  
Step 7: Exit with success for the success and Exit with Failures for any failures.  

## Output

- Script log
- Script state
- Ticket
- Dataview












