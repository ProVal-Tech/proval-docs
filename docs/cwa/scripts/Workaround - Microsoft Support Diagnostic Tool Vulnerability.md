---
id: 'cwa-msmdt-registry-key-backup'
title: 'MS-MSDT Registry Key Backup and Restore'
title_meta: 'MS-MSDT Registry Key Backup and Restore'
keywords: ['backup', 'restore', 'registry', 'msdt', 'vulnerability']
description: 'This document provides a comprehensive overview of a script designed to back up, remove, or restore the HKEY_CLASSES_ROOT\\ms-msdt registry key. It details the scriptâ€™s execution, parameters, dependencies, process, and expected output, including ticketing features for failure management.'
tags: ['registry', 'backup', 'restore', 'ticket', 'vulnerability', 'windows']
draft: false
unlisted: false
---
## Summary

This script backs up and removes or restores the following registry key:  
**HKEY_CLASSES_ROOT\ms-msdt**  
Key backup location:  
**"C:\Windows\LTSvc\Packages\MSDTRegBackup"**

This Script is automatically executed by the ["ProVal - Development - Workaround - Microsoft Support Diagnostic Tool Vulnerability [G]"](https://proval.itglue.com/DOC-5078775-10072205) Monitor.  

This script can also be run manually. It will give you the option to pass the value for the parameter "Restore" if you run it manually. The "HKEY_CLASSES_ROOT\ms-msdt" key will be restored if the argument is set to 1.  

The script's default behavior is to attempt to export and delete the registry file. The script can create a ticket for failure as well, but to enable the ticketing feature you need to update the value of the Global Variable Ticket to 1. The script's default behavior is to not generate any ticket.  

This script saves the final result to a script state, "MS-MSDT Registry Status" to display the data in the "Microsoft Support Diagnostic Tool Registry Key Audit[Script][Role]" dataview.  

Also, the script will import all the contents of the solution for its first run.  

With the recent update, the script will attempt to restore the key if the recommended patches are installed.  
[https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190)  
Also, it is being called by the ["ProVal - Development - Restore MS-MSDT Registry Key [G]"](https://proval.itglue.com/DOC-5078775-10206203) monitor set and restores the key when called from this new monitor set.

## Sample Run

Leave the Restore field blank to remove the registry key:  
![Leave the Restore field blank](5078775/docs/10072208/images/13967930)  

Set the Restore to 1 for Restoring the registry keys:  
![Set the Restore to 1](5078775/docs/10072208/images/13967936)  

## Dependencies

- [MS-MSDT Registry Key](https://proval.itglue.com/DOC-5078775-10072204)
- [ProVal - Development - Workaround - Microsoft Support Diagnostic Tool Vulnerability [G]](https://proval.itglue.com/DOC-5078775-10072205)
- [ProVal - Development - Restore MS-MSDT Registry Key [G]](https://proval.itglue.com/DOC-5078775-10206203)
- [CVE-2022-30190 MSDT - Workarounds](https://proval.itglue.com/DOC-5078775-10073331)

## Variables

| Name    | Description                                                                 |
|---------|-----------------------------------------------------------------------------|
| OutCome | Store the Output of the PowerShell scripts being executed to perform the necessary action. |
| Tickid  | Variable for retrieving and storing the ticketid of an existing failure ticket. |

### Global Parameters

| Name     | Example | Required | Description                                          |
|----------|---------|----------|------------------------------------------------------|
| Ticketid | 1 or 0  | False    | Set it to 1 to make the script create tickets for the failures. |

### User Parameters

| Name     | Example               | Required | Description                          |
|----------|-----------------------|----------|--------------------------------------|
| Restore  | 1 or leave it blank   | False    | 1 to use the script to restore the key |

### Script States

| Name                        | Example                                     | Description                          |
|-----------------------------|---------------------------------------------|--------------------------------------|
| MS-MSDT Registry Status     | BackedUp And Removed, Failed to Remove, Restored, Failed to Restore | OutCome of the recent operation performed |

## Process

Step 1: Imports all the parts to the solution.  
Step 2: Check if it is called to Restore or to Remove the registry key.  

For Backup and Restore:

Step 1: Clears the script state, "MS-MSDT Registry Status".  
Step 2: Executes the PowerShell Script to take the backup of the registry key and to Remove the key.  
Step 3: Verifies the OutCome of the PowerShell and proceeds accordingly.  
Step 4: For success, it will set the script state as "BackedUp And Removed," and exit.  
Step 5: For the failure, it will set the script state as "Failed to Remove", and checks whether if ticket creation is enabled or not.  
Step 6: If the ticket creation is enabled, it will look for the already existing ticket and add a comment to that otherwise will create a ticket if ticket does not exist.  
Step 7: Exit with success for the success and Exit with Failures for any failures.  

For Restore:

Step 1: Clears the script state, "MS-MSDT Registry Status".  
Step 2: Executes the PowerShell Script to Restore the key.  
Step 3: Verifies the OutCome of the PowerShell and proceeds accordingly.  
Step 4: For success, it will set the script state as "Restored" and exit.  
Step 5: For the failure, it will set the script state as "Failed to Restore", and checks whether if ticket creation is enabled or not.  
Step 6: If the ticket creation is enabled, it will look for the already existing ticket and add a comment to that otherwise will create a ticket if ticket does not exist.  
Step 7: Exit with success for the success and Exit with Failures for any failures.  

## Output

- Script log
- Script state
- Ticket
- Dataview


